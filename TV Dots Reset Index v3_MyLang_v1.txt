UPARROW := IF(CLOSE > REF(OPEN, XBARSDEL), 1, 0);
DOWNARROW:= IF(CLOSE < REF(OPEN, XBARSDEL), 1, 0);

UPARROW1 := IF(REF(CLOSE, 1) > REF(OPEN, XBARSDEL + 1), 1, 0);
DOWNARROW1:= IF(REF(CLOSE, 1) < REF(OPEN, XBARSDEL + 1), 1, 0);

NETTEDLONGPOSITION := IF(UPARROW = 1, LOTS, 0);
NETTEDLONGPOSITION1 := SUM(NETTEDLONGPOSITION, 1000);
NETTEDLONGPOSITION2 : NETTEDLONGPOSITION1 , COLORLIBLUE;


NETTEDLONGAVG := IF(UPARROW = 1, (LOTS * CLOSE) / (REF(NETTEDLONGPOSITION1, 1) + LOTS), 0);
NETTEDLONGAVG1 := SUM(NETTEDLONGAVG , 1000);

BUYPROFITCUT := IF(REF(NETTEDLONGPOSITION1, 1) = 0 AND NETTEDLONGPOSITION1 > 0, CLOSE * MULTIPLI, 0);
BUYPROFITCUT1 := SUM(BUYPROFITCUT, 1000);

NETTEDSHORTPOSITION := IF(DOWNARROW = 1, LOTS, 0);
NETTEDSHORTPOSITION1 := SUM(NETTEDSHORTPOSITION, 1000);

NETTEDSHORTAVG := IF(DOWNARROW = 1, (LOTS * CLOSE) / (REF(NETTEDSHORTPOSITION1, 1) + LOTS), 0);
NETTEDSHORTAVG1 := SUM(NETTEDSHORTAVG, 1000);

SELLPROFITCUT := IF(REF(NETTEDSHORTPOSITION1, 1) = 0 AND NETTEDSHORTPOSITION1 > 0, CLOSE * MULTIPLI, 0);
SELLPROFITCUT1 := SUM(SELLPROFITCUT, 1000);

BUYPROFIT := (CLOSE - NETTEDLONGAVG1) / TICKSIZE * NETTEDLONGPOSITION1 * TICKVALU;

SELLPROFIT := (NETTEDSHORTAVG1 - CLOSE) / TICKSIZE * NETTEDSHORTPOSITION1 * TICKVALU;

BUYPROFITCUTOFF := BUYPROFITCUT1 > 0 AND BUYPROFIT >= BUYPROFITCUT1;
SELLPROFITCUTOFF := SELLPROFITCUT1 > 0 AND SELLPROFIT >= SELLPROFITCUT1;

BUYPROFITCUT2 : BUYPROFITCUT1 , COLORLIBLUE;
SELLPROFITCUT2 : SELLPROFITCUT1 , COLORLIBLUE;
INDEX := 0;
INDEX1 := IF(BUYPROFITCUTOFF, IF(INDEX <= 0, 1, REF(INDEX, 1) + 1), IF(SELLPROFITCUTOFF, IF(INDEX >= 0, -1, REF(INDEX, 1) - 1), REF(INDEX, 1)));

SIG1: IF(INDEX1 > 0, INDEX1, DRAWNULL), COLORSTICK, COLORLIBLUE;
SIG2: IF(INDEX1 < 0, INDEX1, DRAWNULL), COLORSTICK, COLORRED;